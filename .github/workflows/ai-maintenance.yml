# Ce workflow doit Ãªtre placÃ© dans le repo contenant ton API (par ex. AdminRcvo/API) sous `.github/workflows/ai-maintenance.yml`
# Avant dâ€™exÃ©cuter : vÃ©rifie que le secret OPENAI_API_KEY est bien configurÃ© dans le repo rcvo-API (Settings > Secrets)
name: AI Code Maintenance

on:
  workflow_dispatch:
    inputs:
      change_request:
        description: 'DÃ©cris la modification Ã  appliquer'
        required: true

jobs:
  apply_ai_patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          # Installer jq via apt et OpenAI CLI via npm
          sudo apt-get update && sudo apt-get install -y jq 
          npm install -g openai

          npm install -g openai jq

      - name: Generate patch with OpenAI (using curl & jq)
        run: |
          # Appel direct Ã  l'API OpenAI avec curl
          curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"model":"gpt-4","messages":[{"role":"user","content":"Agis comme un dÃ©veloppeur : ${{ github.event.inputs.change_request }}, fournis-moi un patch git (diff) Ã  appliquer sur ce repo."}],"stream":false}' \
            > patch_response.json
          # Extraire le contenu du patch
          jq -r '.choices[0].message.content' patch_response.json > patch.diff

      - name: Apply patch & commit
        run: |
          git apply patch.diff
          git checkout -b ai-update
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "AI update: ${{ github.event.inputs.change_request }}"
          git push -u origin ai-update

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "AI update: ${{ github.event.inputs.change_request }}"
          title: "ğŸ›  AI update: ${{ github.event.inputs.change_request }}"
          body: |
            Ce PR contient les modifications gÃ©nÃ©rÃ©es par lâ€™IA pour :
            > ${{ github.event.inputs.change_request }}
          base: main
          head: ai-update
